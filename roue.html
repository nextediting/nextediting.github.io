<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Next Editing | Roue de la Fortune</title>
    <style>
        body { background: #050505; color: white; font-family: 'Arial', sans-serif; text-align: center; padding: 50px 20px; }
        .container { max-width: 600px; margin: 0 auto; border: 1px solid #222; padding: 30px; border-radius: 15px; }
        .btn-discord { 
            display: inline-block; background: #5865F2; color: white; padding: 15px 30px; 
            border-radius: 5px; text-decoration: none; font-weight: bold; margin-top: 20px;
            transition: 0.3s;
        }
        .btn-discord:hover { background: #4752c4; transform: scale(1.05); }
        .error { color: #ff4444; margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h1 style="color: #ff0000;">ROUE DE LA FORTUNE</h1>
        <p id="status-text">Pour participer à l'événement, connecte ton compte Discord.</p>
        <p style="font-size: 0.8rem; color: #888;">Nous vérifierons automatiquement si tu as bien fait 2 invitations sur le serveur.</p>

        <a href="#" id="loginBtn" class="btn-discord">SE CONNECTER AVEC DISCORD</a>
        
        <div id="error-msg" class="error"></div>
    </div>

 <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBBNFvN7kjPa7v9x3KRTnXrNNaOAgBNVFo",
        authDomain: "next-editing.firebaseapp.com",
        databaseURL: "https://next-editing-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "next-editing",
        storageBucket: "next-editing.firebasestorage.app",
        messagingSenderId: "862749246676",
        appId: "1:862749246676:web:0d3d418f64793e63026741"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const CLIENT_ID = "1454969132188565707"; 
    const REDIRECT_URI = window.location.href.split('#')[0].split('?')[0]; 

    const loginBtn = document.getElementById('loginBtn');
    const statusText = document.getElementById('status-text');
    const errorMsg = document.getElementById('error-msg');

    loginBtn.href = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=identify`;

    const fragment = new URLSearchParams(window.location.hash.slice(1));
    const accessToken = fragment.get('access_token');

    if (accessToken) {
        loginBtn.style.display = 'none';
        statusText.innerText = "Vérification de ton compte...";

        fetch('https://discord.com/api/users/@me', {
            headers: { authorization: `Bearer ${accessToken}` }
        })
        .then(res => res.json())
        .then(async (user) => {
            const userRef = ref(db, `utilisateurs/${user.id}`);
            const snapshot = await get(userRef);

            if (snapshot.exists()) {
                const userData = snapshot.val();
                const invitesCount = userData.invites || 0;

                if (invitesCount >= 2) {
                    statusText.innerHTML = `<span style="color:#00ff00">Accès Autorisé !</span><br>Bienvenue ${user.username}. Tu as ${invitesCount} invitations.`;
                    // --- ÉTAPE SUIVANTE : Afficher la roue ici ---
                    afficherLaRoue(); 
                } else {
                    statusText.innerHTML = `Accès Refusé.`;
                    errorMsg.innerHTML = `Il te faut 2 invitations (Tu en as : ${invitesCount}).<br>Invite tes amis sur le Discord et réessaie !`;
                }
            } else {
                errorMsg.innerText = "Tu n'es pas encore enregistré dans notre base. Connecte-toi au Discord !";
            }
        })
        .catch(err => {
            errorMsg.innerText = "Erreur lors de la récupération des données.";
            console.error(err);
        });
    }

    function afficherLaRoue() {
        console.log("Lancement de l'affichage de la roue...");
        // On codera l'apparition de la roue à l'étape suivante
    }
</script>
</body>
</html>
