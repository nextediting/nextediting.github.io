<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Next Editing | Roue de la Fortune</title>
    <style>
        :root { --accent: #ff4d4d; --bg: #050505; --card: #111; }
        body { background: var(--bg); color: white; font-family: 'Arial', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        
        .container { background: var(--card); padding: 40px; border-radius: 20px; border: 1px solid #222; width: 100%; max-width: 450px; text-align: center; }
        
        #wheelArea { display: none; margin-top: 20px; position: relative; }
        
        .wheel-container { position: relative; width: 340px; height: 340px; margin: 0 auto; }
        
        .pointer {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent;
            border-top: 30px solid white; z-index: 100;
        }

        .wheel {
            width: 100%; height: 100%; border-radius: 50%; border: 8px solid #222;
            position: relative; overflow: hidden; transition: transform 5s cubic-bezier(0.1, 0, 0.1, 1);
            background: conic-gradient(
                #ff0000 0deg 60deg, #000 60deg 120deg,
                #ff0000 120deg 180deg, #000 180deg 240deg,
                #ff0000 240deg 300deg, #eddf00 300deg 360deg
            );
        }

        .segment-text {
            position: absolute; width: 100%; height: 100%;
            text-align: center; font-weight: bold; font-size: 0.8rem;
            text-transform: uppercase;
        }

        .segment-text span {
            display: inline-block; margin-top: 40px;
        }

        #spinBtn {
            margin-top: 30px; background: var(--accent); color: white; width: 100%;
            padding: 15px; border-radius: 10px; border: none; font-weight: bold;
            cursor: pointer; font-size: 1.1rem; transition: 0.3s;
        }
        
        #spinBtn:disabled { background: #444; cursor: not-allowed; opacity: 0.7; }

        #wheelResult { margin-top: 20px; font-weight: bold; font-size: 1.2rem; min-height: 30px; }
        .btn-discord { background: #5865F2; color: white; padding: 15px 30px; border-radius: 8px; text-decoration: none; display: inline-block; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h1 style="color: var(--accent); margin-bottom: 5px;">ROUE DE LA FORTUNE</h1>
        <p id="status-text" style="color: #888; margin-bottom: 25px;">VÃ©rification de ton accÃ¨s...</p>
        
        <a href="#" id="loginBtn" class="btn-discord">SE CONNECTER AVEC DISCORD</a>

        <div id="wheelArea">
            <div class="wheel-container">
                <div class="pointer"></div>
                <div id="wheel" class="wheel">
                    <div class="segment-text" style="transform: rotate(30deg);"><span>100 CRÃ‰DITS</span></div>
                    <div class="segment-text" style="transform: rotate(90deg);"><span>500 CRÃ‰DITS</span></div>
                    <div class="segment-text" style="transform: rotate(150deg);"><span>200 CRÃ‰DITS</span></div>
                    <div class="segment-text" style="transform: rotate(210deg);"><span>1000 CRÃ‰DITS</span></div>
                    <div class="segment-text" style="transform: rotate(270deg);"><span>200 CRÃ‰DITS</span></div>
                    <div class="segment-text" style="transform: rotate(330deg); color: black;"><span>NITRO</span></div>
                </div>
            </div>
            <button id="spinBtn">LANCER LA ROUE</button>
            <div id="wheelResult"></div>
        </div>
        
        <div id="error-msg" style="color: #ff4444; margin-top: 20px; font-weight: bold;"></div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBBNFvN7kjPa7v9x3KRTnXrNNaOAgBNVFo",
        authDomain: "next-editing.firebaseapp.com",
        databaseURL: "https://next-editing-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "next-editing",
        storageBucket: "next-editing.firebasestorage.app",
        messagingSenderId: "862749246676",
        appId: "1:862749246676:web:0d3d418f64793e63026741"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const CLIENT_ID = "1454969132188565707"; 
    const REDIRECT_URI = window.location.href.split('#')[0].split('?')[0]; 

    const loginBtn = document.getElementById('loginBtn');
    const statusText = document.getElementById('status-text');
    const errorMsg = document.getElementById('error-msg');

    loginBtn.href = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=identify`;

    // --- MODIF 1 : NETTOYAGE URL ET RECOUPERATION TOKEN ---
    const fragment = new URLSearchParams(window.location.hash.slice(1));
    let accessToken = fragment.get('access_token');
    
    if (accessToken) {
        window.history.replaceState({}, document.title, window.location.pathname);
        localStorage.setItem('session_token', accessToken);
    } else {
        accessToken = localStorage.getItem('session_token');
    }

    if (accessToken) {
        loginBtn.style.display = 'none';
        fetch('https://discord.com/api/users/@me', { headers: { authorization: `Bearer ${accessToken}` } })
        .then(res => res.json())
        .then(async (user) => {
            if (!user.id) {
                localStorage.removeItem('session_token');
                return;
            }

            const userRef = ref(db, `utilisateurs/${user.id}`);
            const snapshot = await get(userRef);

            if (snapshot.exists()) {
                const userData = snapshot.val();
                const today = new Date().toLocaleDateString('fr-CA'); 

                if (userData.invites < 2) {
                    errorMsg.innerText = "AccÃ¨s refusÃ© : 2 invitations requises.";
                } 
                // --- MODIF 2 : VERIFICATION DATE POUR BLOQUER F5 ---
                else if (userData.derniere_roue === today) {
                    statusText.innerHTML = `Bienvenue <b style="color:white">${user.username}</b> !`;
                    errorMsg.style.color = "#ffae00";
                    errorMsg.innerText = "Tu as dÃ©jÃ  jouÃ© aujourd'hui. Reviens demain !";
                } else {
                    statusText.innerHTML = `Bienvenue <b style="color:white">${user.username}</b> !`;
                    document.getElementById('wheelArea').style.display = 'block';
                    setupWheel(user.id, userData.credits || 0);
                }
            } else {
                errorMsg.innerText = "Profil non trouvÃ©.";
            }
        });
    }

    function setupWheel(userId, currentCredits) {
        const wheel = document.getElementById('wheel');
        const spinBtn = document.getElementById('spinBtn');
        const result = document.getElementById('wheelResult');
        let isSpinning = false;

        spinBtn.onclick = async () => {
            if (isSpinning) return;
            isSpinning = true;
            spinBtn.disabled = true;
            result.innerText = "ðŸŽ¡ Tirage en cours...";

            const angles = [30, 90, 150, 210, 270]; 
            const targetAngle = angles[Math.floor(Math.random() * angles.length)];
            const rotation = 3600 + (360 - targetAngle); 
            
            wheel.style.transform = `rotate(${rotation}deg)`;

            setTimeout(async () => {
                let gain = 0;
                if (targetAngle === 30) gain = 100;
                else if (targetAngle === 90) gain = 500;
                else if (targetAngle === 150) gain = 200;
                else if (targetAngle === 210) gain = 1000;
                else if (targetAngle === 270) gain = 200;

                const today = new Date().toLocaleDateString('fr-CA');
                
                // Sauvegarde Firebase : CrÃ©dits + Date du jour
                await update(ref(db, `utilisateurs/${userId}`), { 
                    credits: currentCredits + gain,
                    derniere_roue: today 
                });

                result.innerHTML = `GAGNÃ‰ : <span style="color:#00ff00">+${gain} CRÃ‰DITS</span>`;
                
                // Bloque le bouton et rafraÃ®chit pour valider le verrouillage
                setTimeout(() => { location.reload(); }, 3000);
            }, 5000);
        };
    }
</script>
</body>
</html>
