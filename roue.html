<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Next Editing | Roue de la Fortune</title>
    <style>
        :root { --accent: #ff4d4d; --bg: #0f0f0f; --card: #1a1a1a; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', Roboto, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        
        .container { background: var(--card); padding: 40px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); width: 100%; max-width: 500px; text-align: center; border: 1px solid #333; }
        
        h1 { color: var(--accent); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; font-size: 1.8rem; }
        .status-msg { color: #888; font-size: 0.9rem; margin-bottom: 30px; }

        .btn-discord { 
            background: #5865F2; color: white; padding: 14px 28px; border-radius: 12px; 
            text-decoration: none; font-weight: bold; transition: 0.3s; display: inline-block; border: none;
        }
        .btn-discord:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(88, 101, 242, 0.4); }

        /* --- LA ROUE MODERNE --- */
        #wheelArea { display: none; margin-top: 20px; }
        
        .wheel-container { position: relative; width: 350px; height: 350px; margin: 0 auto; filter: drop-shadow(0 0 15px rgba(255, 77, 77, 0.2)); }
        
        /* Le triangle blanc indicateur */
        .pointer {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            width: 30px; height: 30px; background: white; clip-path: polygon(100% 0, 0 0, 50% 100%);
            z-index: 10; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5));
        }

        .wheel {
            width: 100%; height: 100%; border-radius: 50%; border: 10px solid #252525;
            position: relative; overflow: hidden; transition: transform 5s cubic-bezier(0.1, 0, 0.1, 1);
            background: #111;
        }

        /* Les parts de la roue avec SVG pour un alignement parfait du texte */
        .wheel-svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .segment { stroke-width: 32; fill: none; }
        .text-path { fill: white; font-size: 3px; font-weight: bold; text-transform: uppercase; }

        #spinBtn {
            margin-top: 30px; background: var(--accent); color: white; width: 100%;
            padding: 15px; border-radius: 12px; border: none; font-weight: 900;
            cursor: pointer; transition: 0.3s;
        }
        #spinBtn:disabled { background: #444; cursor: not-allowed; }

        #wheelResult { margin-top: 25px; height: 30px; font-weight: bold; font-size: 1.2rem; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Roue de la Fortune</h1>
        <p id="status-text" class="status-msg">Connecte ton compte pour tenter ta chance.</p>
        
        <a href="#" id="loginBtn" class="btn-discord">Se connecter avec Discord</a>

        <div id="wheelArea">
            <div class="wheel-container">
                <div class="pointer"></div>
                <div id="wheel" class="wheel">
                    <svg viewBox="0 0 32 32" class="wheel-svg">
                        <circle r="16" cx="16" cy="16" class="segment" stroke="#e63946" stroke-dasharray="16.75 100" stroke-dashoffset="0" />
                        <circle r="16" cx="16" cy="16" class="segment" stroke="#1a1a1a" stroke-dasharray="16.75 100" stroke-dashoffset="-16.75" />
                        <circle r="16" cx="16" cy="16" class="segment" stroke="#e63946" stroke-dasharray="16.75 100" stroke-dashoffset="-33.5" />
                        <circle r="16" cx="16" cy="16" class="segment" stroke="#1a1a1a" stroke-dasharray="16.75 100" stroke-dashoffset="-50.25" />
                        <circle r="16" cx="16" cy="16" class="segment" stroke="#e63946" stroke-dasharray="16.75 100" stroke-dashoffset="-67" />
                        <circle r="16" cx="16" cy="16" class="segment" stroke="#ffb703" stroke-dasharray="16.75 100" stroke-dashoffset="-83.75" />
                    </svg>
                    <div style="position:absolute; inset:0; pointer-events:none;">
                        <span style="position:absolute; top:20%; left:50%; transform:translateX(-50%) rotate(0deg); font-weight:bold; font-size:0.8rem;">100 pts</span>
                        <span style="position:absolute; top:50%; left:80%; transform:translate(-50%,-50%) rotate(90deg); font-weight:bold; font-size:0.8rem;">500 pts</span>
                        <span style="position:absolute; top:80%; left:50%; transform:translateX(-50%) rotate(180deg); font-weight:bold; font-size:0.8rem;">200 pts</span>
                        <span style="position:absolute; top:50%; left:20%; transform:translate(-50%,-50%) rotate(270deg); font-weight:bold; font-size:0.8rem;">1000 pts</span>
                    </div>
                </div>
            </div>
            <button id="spinBtn">LANCER LA ROUE</button>
            <div id="wheelResult"></div>
        </div>
        
        <div id="error-msg" style="color: #ff4444; margin-top: 20px;"></div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Ta config Firebase (inchangÃ©e)
    const firebaseConfig = {
        apiKey: "AIzaSyBBNFvN7kjPa7v9x3KRTnXrNNaOAgBNVFo",
        authDomain: "next-editing.firebaseapp.com",
        databaseURL: "https://next-editing-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "next-editing",
        storageBucket: "next-editing.firebasestorage.app",
        messagingSenderId: "862749246676",
        appId: "1:862749246676:web:0d3d418f64793e63026741"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const CLIENT_ID = "1454969132188565707"; 
    const REDIRECT_URI = window.location.href.split('#')[0].split('?')[0]; 

    const loginBtn = document.getElementById('loginBtn');
    const statusText = document.getElementById('status-text');

    loginBtn.href = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=identify`;

    const fragment = new URLSearchParams(window.location.hash.slice(1));
    const accessToken = fragment.get('access_token');

    if (accessToken) {
        loginBtn.style.display = 'none';
        statusText.innerText = "VÃ©rification...";

        fetch('https://discord.com/api/users/@me', {
            headers: { authorization: `Bearer ${accessToken}` }
        })
        .then(res => res.json())
        .then(async (user) => {
            const userRef = ref(db, `utilisateurs/${user.id}`);
            const snapshot = await get(userRef);

            if (snapshot.exists() && snapshot.val().invites >= 2) {
                statusText.innerHTML = `Bienvenue <b style="color:white">${user.username}</b> !`;
                document.getElementById('wheelArea').style.display = 'block';
                setupWheel(user.id, snapshot.val().credits || 0);
            } else {
                document.getElementById('error-msg').innerText = "AccÃ¨s refusÃ© : 2 invitations requises.";
            }
        });
    }

    function setupWheel(userId, currentCredits) {
        const wheel = document.getElementById('wheel');
        const spinBtn = document.getElementById('spinBtn');
        const result = document.getElementById('wheelResult');
        let isSpinning = false;

        spinBtn.onclick = async () => {
            if (isSpinning) return;
            isSpinning = true;
            spinBtn.disabled = true;
            result.innerText = "ðŸŽ¡ Tirage en cours...";

            const targetAngle = [0, 60, 120, 180, 240][Math.floor(Math.random() * 5)];
            const rotation = 2160 + targetAngle; // 6 tours + l'angle

            wheel.style.transform = `rotate(${rotation}deg)`;

            setTimeout(async () => {
                isSpinning = false;
                let gain = 0;
                // Logique simplifiÃ©e selon l'angle d'arrÃªt
                const landing = targetAngle;
                if (landing === 0) gain = 100;
                else if (landing === 60) gain = 1000;
                else if (landing === 120) gain = 200;
                else if (landing === 180) gain = 500;
                else gain = 200;

                result.innerHTML = `GAGNÃ‰ : <span style="color:#00ff00">+${gain} CRÃ‰DITS</span>`;
                
                // --- Ã‰TAPE SUIVANTE : Mise Ã  jour Firebase ---
                const newTotal = currentCredits + gain;
                await update(ref(db, `utilisateurs/${userId}`), { credits: newTotal });
                console.log("Base de donnÃ©es mise Ã  jour !");
            }, 5000);
        };
    }
</script>
</body>
</html>
